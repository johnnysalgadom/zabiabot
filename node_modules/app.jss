'use strict';

// Imports
const express = require('express');
const bodyParser = require('body-parser');
const Smooch = require('smooch-core');

// Config
const PORT = 8000;
const KEY_ID = 'app_5b03768551a83900227a8ae6';
const SECRET = 'YyjH7Dw4-yU5d0zLtIGsOonc';

const smooch = new Smooch({
    keyId: KEY_ID,
    secret: SECRET,
    scope: 'app'
})

// Server https://expressjs.com/en/guide/routing.html
const app = express();

app.use(bodyParser.json());

var i = 0;
//recibir mensajes desde Smooch a través de webhook
app.post('/message', function(req, res) {
    console.log('===================...' + i);
    i++;

    console.log('webhook PAYLOAD\n', JSON.stringify(req.body, null, 4));

    const appUserId = req.body.appUser._id;
    const nombreUsuario = (req.body.appUser.givenName != 'undefined' && req.body.appUser.givenName != '') ? req.body.appUser.givenName : req.body.appUser.userId;
    const saludo = 'Hola ' + nombreUsuario;

    if (req.body.trigger == 'message:appUser') {

        const smoochPayload = (req.body.messages[0].payload != '' && req.body.messages[0].payload != undefined) ? req.body.messages[0].payload : '';

        if (smoochPayload == '' || smoochPayload == undefined) {

            smooch.appUsers.sendMessage(appUserId, {
                text: saludo + ', ¿en que te gustaria enfocarte hoy?',
                role: 'appMaker',
                type: 'text'
            }).then((response) => {
                console.log('api response:\n ', response);
                res.end();
            }).catch((err) => {
                console.log('api err:\n ', err);
                res.end();
            });

            smooch.appUsers.sendMessage(appUserId, {
                role: 'appMaker',
                type: 'carousel',
                items: [{
                    title: 'Sentirse bien',
                    mediaUrl: 'https://www.southtech.pe/zabiatest/imagen/icono/sentirsebien.png',
                    mediaType: 'image/png',
                    actions: [{
                        text: 'Seleccionar',
                        type: 'postback',
                        payload: 'SENTIRSE_BIEN'
                    }]
                }, {
                    title: 'Mantenerse activo',
                    mediaUrl: 'https://www.southtech.pe/zabiatest/imagen/icono/mantenerseactivo.png',
                    mediaType: 'image/png',
                    actions: [{
                        text: 'Seleccionar',
                        type: 'postback',
                        payload: 'MANTENERSE_ACTIVO'
                    }]
                }, {
                    title: 'Comer sano',
                    mediaUrl: 'https://www.southtech.pe/zabiatest/imagen/icono/mandarinas.png',
                    mediaType: 'image/png',
                    actions: [{
                        text: 'Seleccionar',
                        type: 'postback',
                        payload: 'COMER_SANO'
                    }]
                }]
            }).then(() => {
                // async code
            });
        } else {

            if (smoochPayload == 'SI') {

                smooch.appUsers.sendMessage(appUserId, {
                    role: 'appMaker',
                    type: 'carousel',
                    items: [{
                        title: 'Sentirse bien',
                        mediaUrl: 'https://www.southtech.pe/zabiatest/imagen/icono/sentirsebien.png',
                        mediaType: 'image/png',
                        actions: [{
                            text: 'Seleccionar',
                            type: 'postback',
                            payload: 'SENTIRSE_BIEN'
                        }]
                    }, {
                        title: 'Mantenerse activo',
                        mediaUrl: 'https://www.southtech.pe/zabiatest/imagen/icono/mantenerseactivo.png',
                        mediaType: 'image/png',
                        actions: [{
                            text: 'Seleccionar',
                            type: 'postback',
                            payload: 'MANTENERSE_ACTIVO'
                        }]
                    }, {
                        title: 'Comer sano',
                        mediaUrl: 'https://www.southtech.pe/zabiatest/imagen/icono/mandarinas.png',
                        mediaType: 'image/png',
                        actions: [{
                            text: 'Seleccionar',
                            type: 'postback',
                            payload: 'COMER_SANO'
                        }]
                    }]
                }).then(() => {
                    // async code
                });

            } else if (smoochPayload == 'NO') {

                smooch.appUsers.sendMessage(appUserId, {
                    text: 'Ok, Gracias ' + nombreUsuario + ', aquí estoy siempre! Bye',
                    role: 'appMaker',
                    type: 'text'
                }).then((response) => {
                    console.log('api response:\n ', response);
                    res.end();
                }).catch((err) => {
                    console.log('api err:\n ', err);
                    res.end();
                });

            } else {

                var mensajeSiente = '';
                var imagenSiente = ''; //getRandomInt(1, 23) + '.png';

                switch (smoochPayload) {
                    case 'FELIZ':
                        mensajeSiente = 'Que Bien! ' + nombreUsuario + ', Sentirse Feliz es estar bien con uno mismo en cada momento.';
                        imagenSiente = '1.png';
                        break;
                    case 'TRISTE':
                        mensajeSiente = nombreUsuario + ', Hay momentos negativos en nuestras vidas que no vamos a poder controlar pero si podemos elegir como no sentimos al respecto';
                        imagenSiente = '2.png';
                        break;
                    case 'MIEDO':
                        mensajeSiente = 'El Miedo es una sensación desagradable, ' + nombreUsuario + ', provocada por la percepción de un peligro real o imaginario';
                        imagenSiente = '3.png';
                        break;
                    case 'IRA':
                        mensajeSiente = nombreUsuario + ', La Ira es un sentimiento negativo y lo mejor es que la exterioricemos de alguna manera para evitar que devenga una enfermedad';
                        imagenSiente = '4.png';
                        break;
                    case 'NORMAL':
                        imagenSiente = '5.png';
                        break;
                    default:
                        break;
                }

                smooch.appUsers.sendMessage(appUserId, {
                    text: mensajeSiente + '\n\nUna buena alimentación, ejercicios físicos y / o actividades recreacionales, te ayudan a tu estado anímico y a Sentirse Bien ',
                    role: 'appMaker',
                    type: 'text'
                }).then((response) => {
                    console.log('api response:\n ', response);
                    res.end();
                }).catch((err) => {
                    console.log('api err:\n ', err);
                    res.end();
                });

                smooch.appUsers.sendMessage(appUserId, {
                    type: 'image',
                    mediaUrl: 'https://southtech.pe/zabiatest/imagen/icono/recomendacion/' + imagenSiente,
                    role: 'appMaker'
                }).then((response) => {
                    console.log('api response:\n ', response);
                    res.end();
                }).catch((err) => {
                    console.log('api err:\n ', err);
                    res.end();
                });

                smooch.appUsers.sendMessage(appUserId, {
                    text: '¿Te puedo ayudar en algo más?',
                    role: 'appMaker',
                    type: 'text',
                    actions: [{
                        type: 'reply',
                        text: 'Si',
                        payload: 'SI'
                    }, {
                        type: 'reply',
                        text: 'No',
                        payload: 'NO'
                    }]
                }).then((response) => {
                    console.log('api response:\n ', response);
                    res.end();
                }).catch((err) => {
                    console.log('api err:\n ', err);
                    res.end();
                });

            }

        }
    }

    if (req.body.trigger == 'postback') {

        const postbackPayload = (req.body.postbacks[0].action.payload != '' && req.body.postbacks[0].action.payload != undefined) ? req.body.postbacks[0].action.payload : '';

        if (postbackPayload == 'SENTIRSE_BIEN') {
            smooch.appUsers.sendMessage(appUserId, {
                text: '¿Cómo te sientes hoy?',
                role: 'appMaker',
                type: 'text',
                actions: [{
                    type: 'reply',
                    text: 'Feliz',
                    iconUrl: 'https://www.southtech.pe/zabiatest/imagen/icono/feliz.png',
                    payload: 'FELIZ'
                }, {
                    type: 'reply',
                    text: 'Triste',
                    iconUrl: 'https://www.southtech.pe/zabiatest/imagen/icono/triste.png',
                    payload: 'TRISTE'
                }, {
                    type: 'reply',
                    text: 'Con miedo',
                    iconUrl: 'https://www.southtech.pe/zabiatest/imagen/icono/miedo.png',
                    payload: 'MIEDO'
                }, {
                    type: 'reply',
                    text: 'Con ira',
                    iconUrl: 'https://www.southtech.pe/zabiatest/imagen/icono/ira.png',
                    payload: 'IRA'
                }, {
                    type: 'reply',
                    text: 'Normal',
                    iconUrl: 'https://www.southtech.pe/zabiatest/imagen/icono/normal.png',
                    payload: 'NORMAL'
                }]
            }).then((response) => {
                console.log('api response:\n ', response);
                res.end();
            }).catch((err) => {
                console.log('api err:\n ', err);
                res.end();
            });

        } else if (postbackPayload == 'COMER_SANO') {

            smooch.appUsers.sendMessage(appUserId, {
                text: 'Excelente ' + nombreUsuario + ', ¿Déjame ver cómo te puedo apoyar?',
                role: 'appMaker',
                type: 'text'
            }).then((response) => {
                smooch.appUsers.sendMessage(appUserId, {
                    role: 'appMaker',
                    type: 'carousel',
                    items: [{
                        title: 'Sitios',
                        mediaUrl: 'https://www.southtech.pe/zabiatest/imagen/icono/sitio.jpg',
                        mediaType: 'image/jpg',
                        actions: [{
                            text: 'Seleccionar',
                            type: 'postback',
                            payload: 'SITIO'
                        }]
                    }, {
                        title: 'Tips',
                        mediaUrl: 'https://www.southtech.pe/zabiatest/imagen/icono/loginzan.png',
                        mediaType: 'image/png',
                        actions: [{
                            text: 'Seleccionar',
                            type: 'postback',
                            payload: 'TIP'
                        }]
                    }, {
                        title: 'Recetas',
                        mediaUrl: 'https://www.southtech.pe/zabiatest/imagen/icono/pitahayasalad.jpg',
                        mediaType: 'image/jpg',
                        actions: [{
                            text: 'Seleccionar',
                            type: 'postback',
                            payload: 'RECETA'
                        }]
                    }, {
                        title: 'Nutrientes',
                        mediaUrl: 'https://www.southtech.pe/zabiatest/imagen/icono/Avocado_facts.jpeg',
                        mediaType: 'image/jpeg',
                        actions: [{
                            text: 'Seleccionar',
                            type: 'postback',
                            payload: 'NUTRIENTE'
                        }]
                    }]
                }).then(() => {
                    // async code
                });
                console.log('api response:\n ', response);
                res.end();
            }).catch((err) => {
                console.log('api err:\n ', err);
                res.end();
            });

        } else if (postbackPayload == 'MANTENERSE_ACTIVO') {

        } else if (postbackPayload == 'SITIO') {
            smooch.appUsers.sendMessage(appUserId, {
                role: "appMaker",
                type: "list",
                items: [{
                        title: "Aromas Peruanos",
                        description: "Buffet con más de treinta y cinco platos criollos y marinos.\nAv. Guardia Civil 856, San Isidro",
                        size: "large",
                        mediaUrl: "https://www.southtech.pe/zabiatest/imagen/restaurante/aromas-peruanos-logo_side.jpg",
                        mediaType: 'image/jpg',
                        actions: [{
                            text: "Aromas Peruanos!",
                            type: "postback",
                            payload: "SITIO_FIN"
                        }]
                    },
                    {
                        title: "Astrid y Gastón",
                        description: "El toque de Astrid y Gastón\nAv. Paz Soldán 290, San Isidro",
                        mediaUrl: "https://southtech.pe/zabiatest/imagen/restaurante/astrid-y-gaston-logo_side.jpg",
                        mediaType: 'image/jpg',
                        actions: [{
                            text: "Astrid y Gastón!",
                            type: "postback",
                            payload: "SITIO_FIN"
                        }]
                    },
                    {
                        title: "Mara biomarket",
                        description: "Pproductos orgánicos y naturales.\nAv. Camino Real 1251, San Isidro ",
                        mediaUrl: "https://southtech.pe/zabiatest/imagen/biotienda/mara.jpg",
                        mediaType: 'image/jpg',
                        actions: [{
                            text: "Mara biomarket!",
                            type: "postback",
                            payload: "SITIO_FIN"
                        }]
                    }
                ]
            }).then(() => {
                // async code
            });
        } else if (postbackPayload == 'SITIO_FIN') {
            smooch.appUsers.sendMessage(appUserId, {
                text: '¿Te puedo ayudar en algo más?',
                role: 'appMaker',
                type: 'text',
                actions: [{
                    type: 'reply',
                    text: 'Si',
                    payload: 'SI'
                }, {
                    type: 'reply',
                    text: 'No',
                    payload: 'NO'
                }]
            }).then((response) => {
                console.log('api response:\n ', response);
                res.end();
            }).catch((err) => {
                console.log('api err:\n ', err);
                res.end();
            });
        } else {
            smooch.appUsers.sendMessage(appUserId, {
                text: 'implementando...',
                role: 'appMaker',
                type: 'text'
            }).then((response) => {
                console.log('postback  response:\n ', response);
                res.end();
            }).catch((err) => {
                console.log('postback error:\n ', err);
                res.end();
            });
        }
    }

});

// Listen on port
app.listen(PORT, () => {
    console.log(`App listening on port ${PORT}`);
});


//functions
function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min)) + min;
}

function sleep(milisegundos) {
    for (i = 0; i < milisegundos; i++) {
        //
    }
}